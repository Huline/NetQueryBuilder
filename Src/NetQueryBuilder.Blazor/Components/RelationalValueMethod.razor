@using System.Linq.Expressions
@using NetQueryBuilder.Conditions
@if (MethodCallExpression.Method.Name.Contains("Like", StringComparison.OrdinalIgnoreCase))
{
    <MudTextField Label="Value" T="string" Value="@GetStringValue(MethodCallExpression.Arguments[2])" ValueChanged="UpdateValue"/>
}
@if (MethodCallExpression.Method.Name.Contains("Contains", StringComparison.OrdinalIgnoreCase))
{
    @switch (_memberType)
    {
        case Type stringType when stringType == typeof(string):
            <RelationValueInList T="string" MethodCallExpression="MethodCallExpression" OnUpdateValue="UpdateValue" OnUpdateValues="UpdateValue"/>
            break;
        case Type intType when intType == typeof(int):
            <RelationValueInList T="int" MethodCallExpression="MethodCallExpression" OnUpdateValue="UpdateValue" OnUpdateValues="UpdateValue"/>
            break;
    }
}

@code {
    [Parameter] public LogicalCondition Condition { get; set; }
    [Parameter] public Action<Expression> OnUpdateValue { get; set; }

    private MethodCallExpression MethodCallExpression;
    private Type _memberType;

    protected override void OnParametersSet()
    {
        MethodCallExpression = (MethodCallExpression)Condition.Compile();
        _memberType = ((MemberExpression)MethodCallExpression.Arguments[1]).Type;
    }

    private string GetStringValue(Expression expression)
    {
        // Gère les différents types d'expressions possibles
        switch (expression)
        {
            case ConstantExpression constExpr:
                return constExpr.Value?.ToString() ?? string.Empty;

            case UnaryExpression unaryExpr when unaryExpr.NodeType == ExpressionType.Convert
                                                && unaryExpr.Operand is ConstantExpression constOperand:
                return constOperand.Value?.ToString() ?? string.Empty;

            default:
                return string.Empty; // Valeur par défaut
        }
    }


    private void UpdateValue<T>(T value)
    {
        Condition.Value = value;
        OnUpdateValue.Invoke(Expression.Constant(value, typeof(T)));
    }

}
