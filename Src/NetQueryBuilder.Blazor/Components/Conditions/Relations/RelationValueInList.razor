@using System.Linq.Expressions
@typeparam T

<MudPaper Elevation="0" Class="pa-2" Outlined="true">
    <MudText Typo="Typo.subtitle2" Class="mb-2">Valeurs de la liste</MudText>
    <MudButtonGroup Variant="Variant.Outlined" Size="Size.Small" Class="mb-3">
        <MudButton StartIcon="@Icons.Material.Filled.Add"
                   Color="Color.Primary"
                   OnClick="@OpenDialog">
            Ajouter une valeur
        </MudButton>
    </MudButtonGroup>

    @* MultiSelection="true" Filter="true" *@
    <MudChipSet T="T" Class="mb-2">
        @foreach (var item in Items)
        {
            <MudChip Color="Color.Primary"
                     Size="Size.Small"
                     T="T"
                     OnClose="@(value => RemoveListItem(item))"
                     Label="true"
                     CloseIcon="@Icons.Material.Filled.Close">
                @item?.ToString()
            </MudChip>
        }
    </MudChipSet>
</MudPaper>

<MudDialog @bind-Visible="_showListItemDialog" Options="_listItemDialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">Ajouter une valeur</MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField Label="Valeur" T="T" @bind-Value="_listItemInputValue" Variant="Variant.Outlined"/>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" Color="Color.Default" OnClick="@(() => _showListItemDialog = false)">
            Annuler
        </MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@AddListItem">
            Ajouter
        </MudButton>
    </DialogActions>
</MudDialog>


@code {
    [Parameter] public MethodCallExpression MethodCallExpression { get; set; } = null!;

    [Parameter] public Action<T> OnUpdateValue { get; set; } = null!;

    [Parameter] public Action<IEnumerable<T>> OnUpdateValues { get; set; } = null!;

    private T? _listItemInputValue;
    private List<T> _items = new();
    private bool _showListItemDialog;
    private readonly DialogOptions _listItemDialogOptions = new() { CloseButton = true };

    // Propriété pour accéder aux éléments de manière cohérente
    private IEnumerable<T> Items => _items;

    protected override void OnParametersSet()
    {
        // Si l'argument est un ConstantExpression, on récupère sa valeur
        if (MethodCallExpression.Arguments[0] is ConstantExpression constantExpression)
        {
            _items = ((IEnumerable<T>)constantExpression.Value! ?? Array.Empty<T>()).ToList();
        }
        // Si c'est un NewExpression, on part du principe que c'est une liste vide
        else if (MethodCallExpression.Arguments[0] is NewExpression)
        {
            // La liste est déjà initialisée comme vide
        }
    }

    private void OpenDialog()
    {
        _showListItemDialog = true;
    }

    private void AddListItem()
    {
        if (_listItemInputValue is not null)
            _items.Add(_listItemInputValue);
        _showListItemDialog = false;
        _listItemInputValue = default;
        UpdateValues(_items);
    }

    private void RemoveListItem(T item)
    {
        if (item is null) return;
        var chip = _items.FirstOrDefault(i => i?.Equals(item) == true);
        if (chip is null)
            return;
        _items.Remove(chip);
        UpdateValues(_items);
    }

    private void UpdateValue(T value)
    {
        OnUpdateValue.Invoke(value);
    }

    private void UpdateValues(IEnumerable<T> value)
    {
        OnUpdateValues.Invoke(value);
    }

}