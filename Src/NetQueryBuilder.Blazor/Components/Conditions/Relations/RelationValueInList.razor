@using System.Linq.Expressions
@typeparam T

<div class="nqb-paper nqb-paper-outlined" style="padding: 16px;">
    <h6 class="nqb-text-subtitle2" style="margin-bottom: 16px;">Valeurs de la liste</h6>
    <div class="nqb-button-group" style="margin-bottom: 24px;">
        <Button Variant="outlined" 
                Size="small" 
                Color="primary"
                OnClick="@OpenDialog">
            <Icon Name="add" Size="small" /> Ajouter une valeur
        </Button>
    </div>

    <div class="nqb-chipset" style="margin-bottom: 16px; display: flex; flex-wrap: wrap; gap: 8px;">
        @foreach (var item in Items)
        {
            <Chip Color="primary"
                  Size="small"
                  OnDelete="@(() => RemoveListItem(item))">
                @item?.ToString()
            </Chip>
        }
    </div>
</div>

@if (_showListItemDialog)
{
    <div class="nqb-dialog-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;" @onclick="@(() => _showListItemDialog = false)">
        <div class="nqb-dialog" style="background: var(--nqb-surface); border-radius: var(--nqb-border-radius); min-width: 400px; max-width: 90vw;" @onclick:stopPropagation="true">
            <div class="nqb-dialog-title" style="padding: 24px 24px 16px; border-bottom: 1px solid var(--nqb-border-color);">
                <h6 class="nqb-text-h6" style="margin: 0;">Ajouter une valeur</h6>
            </div>
            <div class="nqb-dialog-content" style="padding: 24px;">
                <TextField Label="Valeur" @bind-Value="_inputStringValue" Variant="outlined"/>
            </div>
            <div class="nqb-dialog-actions" style="padding: 16px 24px 24px; display: flex; gap: 8px; justify-content: flex-end;">
                <Button Variant="text" Color="default" OnClick="@(() => _showListItemDialog = false)">
                    Annuler
                </Button>
                <Button Variant="filled" Color="primary" OnClick="@AddListItem">
                    Ajouter
                </Button>
            </div>
        </div>
    </div>
}


@code {
    [Parameter] public MethodCallExpression MethodCallExpression { get; set; } = null!;

    [Parameter] public Action<T> OnUpdateValue { get; set; } = null!;

    [Parameter] public Action<IEnumerable<T>> OnUpdateValues { get; set; } = null!;

    private string _inputStringValue = "";
    private List<T> _items = new();
    private bool _showListItemDialog;
    // Removed DialogOptions - now using simple boolean for dialog visibility

    // Propriété pour accéder aux éléments de manière cohérente
    private IEnumerable<T> Items => _items;

    protected override void OnParametersSet()
    {
        // Si l'argument est un ConstantExpression, on récupère sa valeur
        if (MethodCallExpression.Arguments[0] is ConstantExpression constantExpression)
        {
            _items = ((IEnumerable<T>)constantExpression.Value! ?? Array.Empty<T>()).ToList();
        }
        // Si c'est un NewExpression, on part du principe que c'est une liste vide
        else if (MethodCallExpression.Arguments[0] is NewExpression)
        {
            // La liste est déjà initialisée comme vide
        }
    }

    private void OpenDialog()
    {
        _showListItemDialog = true;
    }

    private void AddListItem()
    {
        if (!string.IsNullOrEmpty(_inputStringValue))
        {
            // Try to convert string input to type T
            var convertedValue = ConvertStringToT(_inputStringValue);
            if (convertedValue is not null)
            {
                _items.Add(convertedValue);
            }
        }
        _showListItemDialog = false;
        _inputStringValue = "";
        UpdateValues(_items);
    }
    
    private T? ConvertStringToT(string value)
    {
        try
        {
            var type = typeof(T);
            var underlyingType = Nullable.GetUnderlyingType(type) ?? type;
            
            if (underlyingType == typeof(string))
            {
                return (T)(object)value;
            }
            else if (underlyingType.IsEnum)
            {
                if (Enum.TryParse(underlyingType, value, true, out var enumValue) && enumValue != null)
                    return (T)enumValue;
            }
            else
            {
                var converted = Convert.ChangeType(value, underlyingType, System.Globalization.CultureInfo.InvariantCulture);
                return (T)converted;
            }
        }
        catch
        {
            // Ignore conversion errors
        }
        return default(T);
    }

    private void RemoveListItem(T item)
    {
        if (item is null) return;
        var chip = _items.FirstOrDefault(i => i?.Equals(item) == true);
        if (chip is null)
            return;
        _items.Remove(chip);
        UpdateValues(_items);
    }

    private void UpdateValue(T value)
    {
        OnUpdateValue.Invoke(value);
    }

    private void UpdateValues(IEnumerable<T> value)
    {
        OnUpdateValues.Invoke(value);
    }

}