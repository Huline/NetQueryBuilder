@using System.Linq.Expressions
@using NetQueryBuilder.Conditions
@using NetQueryBuilder.Queries
@if (Condition.Compile() is BinaryExpression)
{
    @switch (Condition.PropertyPath.PropertyType)
    {
        case { } intType when intType == typeof(int):
            <MudTextField Label="Value" T="int" Value="@((int)Condition.Value)" ValueChanged="@UpdateValue"/>
            break;
        case { } stringType when stringType == typeof(string):
            <MudTextField Label="Value" T="string" Value="@(Condition.Value?.ToString())" ValueChanged="@UpdateValue"/>
            break;
        case { } boolType when boolType == typeof(bool):
            <MudSelect Label="Value" T="bool" Value="@((bool)Condition.Value)" ValueChanged="@UpdateValue">
                <MudSelectItem Value="true">True</MudSelectItem>
                <MudSelectItem Value="false">False</MudSelectItem>
            </MudSelect>
            break;
        case { } dateTimeType when dateTimeType == typeof(DateTime):
            <MudDatePicker Label="Value" Date="@((DateTime)Condition.Value)" DateChanged="@UpdateValue"/>
            break;
    }
}
@if (Condition.Compile() is MethodCallExpression)
{
    <RelationalValueMethod OnUpdateValue="@UpdateValue" Condition="@Condition"></RelationalValueMethod>
}


@code {

    [CascadingParameter] public IQuery Query { get; set; }

    [Parameter] public SimpleCondition Condition { get; set; }

    private void UpdateValue(DateTime? dateTime)
    {
        if (dateTime.HasValue)
        {
            UpdateValue(dateTime.Value);
        }
    }

    private void UpdateValue<T>(T value)
    {
        Condition.Value = value;
        UpdateValue((Expression)Expression.Constant(value, typeof(T)));
    }

    private void UpdateValue(Expression expression)
    {
        // TODO: Unit test
        // if (Query._lambda.Body is BinaryExpression binaryExpression)
        // {
        //     var updated = binaryExpression.ReplaceRight(expression);
        //     OnValueChanged(updated);
        // }
        // // TODO: Unit test
        // else if (Query._lambda.Body is MethodCallExpression methodCallExpression)
        // {
        //     if (methodCallExpression.Method.Name == "Like")
        //     {
        //         var updated = methodCallExpression.Update(methodCallExpression.Object, new[] { methodCallExpression.Arguments[0], methodCallExpression.Arguments[1], expression });
        //         OnValueChanged(updated);
        //     }
        //
        //     if (methodCallExpression.Method.Name == "Contains")
        //     {
        //         var updated = methodCallExpression.Update(methodCallExpression.Object, new[] { expression, methodCallExpression.Arguments[1] });
        //         OnValueChanged(updated);
        //     }
        // }
    }

}
