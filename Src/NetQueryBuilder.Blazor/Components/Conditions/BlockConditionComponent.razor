@using System.Linq.Expressions
@using NetQueryBuilder.Conditions
<MudPaper Class="pa-2" Style=@("margin-left:" + IndentationLevel * 20 + "px;")>
    <MudGrid Spacing="3">
        <MudItem xs="12" sm="12">
            <MudStack Row Spacing="3">
                <MudButton Variant="Variant.Outlined" OnClick="@(() => AddPredicate(ExpressionType.AndAlso))">And/Or</MudButton>
                <MudButton Variant="Variant.Outlined" OnClick="@(() => GroupConditions())">Group</MudButton>
                @if (Condition.Parent != null)
                {
                    <MudButton Variant="Variant.Outlined" OnClick="@(() => UnGroupConditions())">Ungroup</MudButton>
                }
            </MudStack>
        </MudItem>
        @foreach (var childCondition in Condition.Conditions)
        {
            if (childCondition != Condition.Conditions.First())
            {
                <MudItem xs="12" sm="12">
                    <MudSelect T="LogicalOperator" Label="Operator" Value="@childCondition.LogicalOperator" ValueChanged="@(v => ChangeOperator(childCondition, v))">
                        @foreach (var item in _operators)
                        {
                            <MudSelectItem T="LogicalOperator" Value="@item">@item.ToString()</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
            }

            <MudItem xs="12" sm="2">
                <MudStack Row Spacing="3">
                    <MudIconButton Variant="Variant.Outlined" Icon="@Icons.Material.Filled.Delete" OnClick="e => RemovePredicate(childCondition)"></MudIconButton>
                    <MudCheckBox T="bool" Label="Group" ValueChanged="@(e => Select(e, childCondition))"/>
                </MudStack>
            </MudItem>
            <MudItem xs="12" sm="10">
                <ConditionComponent Condition="childCondition"></ConditionComponent>
            </MudItem>
        }
    </MudGrid>
</MudPaper>

@code {
    [Parameter] public BlockCondition Condition { get; set; } = null!;

    [Parameter] public int IndentationLevel { get; set; }


    List<ICondition> SelectedConditions { get; } = new();

    readonly IEnumerable<LogicalOperator> _operators = Enum.GetValues<LogicalOperator>();

    private void GroupConditions()
    {
        Condition.Group(SelectedConditions);
        SelectedConditions.Clear();
    }

    private void UnGroupConditions()
    {
        Condition.Ungroup(SelectedConditions);
        SelectedConditions.Clear();
    }

    private void Select(bool e, ICondition childCondition)
    {
        if (e)
            SelectedConditions.Add(childCondition);
        else
            SelectedConditions.Remove(childCondition);
    }

    private void AddPredicate(ExpressionType binaryExpressionType)
    {
        Condition.CreateNew();
    }

    private void RemovePredicate(ICondition condition)
    {
        Condition.Remove(condition);
    }

    private void ChangeOperator(ICondition condition, LogicalOperator op)
    {
        condition.LogicalOperator = op;
    }

}